openapi: 3.0.3
info:
  title: ChattyCathy API
  description: |
    ChattyCathy API Server with JWT authentication and RBAC.

    ## Authentication

    This API uses JWT (RS256) authentication with access and refresh tokens.

    - **Access tokens**: Short-lived (15 min), used in Authorization header
    - **Refresh tokens**: Long-lived (7 days), used to obtain new access tokens

    ### Authentication Methods

    - **Google OAuth**: Sign in with Google (recommended for users)
    - **Username/Password**: Traditional login (for demo/testing)

    ### For Web Clients
    Tokens are automatically set as HTTP-only cookies after login.

    ### For Mobile/API Clients
    Use the `Authorization: Bearer <token>` header with access tokens.

    ## Role-Based Access Control (RBAC)

    The API implements permission-based access control:

    ### Default Roles
    - **admin**: Full access to all resources
    - **user**: Basic read access (ping, news) - *automatically assigned to new users*
    - **editor**: Read and write access to content

    ### Default Permissions
    - `ping:read` - Access ping endpoint
    - `news:read`, `news:create`, `news:update`, `news:delete`
    - `users:read`, `users:create`, `users:update`, `users:delete`
    - `roles:read`, `roles:create`, `roles:update`, `roles:delete`

    ### Automatic Role Assignment
    New users registered via Google OAuth are automatically assigned the **user** role,
    which grants `ping:read` and `news:read` permissions.

    ### Admin UI
    
    Admins can also manage role permissions through the web interface at `/admin`.
    Navigate to your profile menu and select "Role & Permission Management".
    
    > **Note:** Permissions are baked into JWT tokens at login time. 
    > After modifying role permissions, affected users must log out and log back in 
    > to receive their updated permissions.
  version: 1.0.0
  contact:
    name: API Support
servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: http://api.localhost/api/v1
    description: Docker development (via Traefik)

tags:
  - name: health
    description: Health check endpoints
  - name: auth
    description: Authentication endpoints (login, logout, OAuth)
  - name: google
    description: Google OAuth authentication
  - name: protected
    description: Protected endpoints (require authentication and permissions)
  - name: admin
    description: Admin endpoints for managing roles and permissions (requires admin role)

paths:
  /ping:
    get:
      summary: Ping the server
      description: |
        Returns pong and records the ping in the database.

        **Requires authentication** and the `ping:read` permission.
      operationId: ping
      tags:
        - protected
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PingResponse"
        "401":
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - missing ping:read permission
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /health:
    get:
      summary: Liveness probe
      description: Basic health check for container orchestration
      operationId: health
      tags:
        - health
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /ready:
    get:
      summary: Readiness probe
      description: Checks if the service is ready (database and Redis connected)
      operationId: ready
      tags:
        - health
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadyResponse"
        "503":
          description: Service not ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadyResponse"

  /auth/google/config:
    get:
      summary: Get Google OAuth configuration
      description: |
        Returns the Google OAuth client ID and redirect URI for initiating the OAuth flow.
      operationId: getGoogleConfig
      tags:
        - google
      responses:
        "200":
          description: Google OAuth configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoogleConfigResponse"

  /auth/google:
    post:
      summary: Authenticate with Google
      description: |
        Authenticate using a Google OAuth access token or authorization code.

        **Implicit Flow (recommended for SPAs):**
        Send the `access_token` received from Google's OAuth popup.

        **Authorization Code Flow:**
        Send the `code` received from Google's redirect.

        On success, returns JWT tokens and user info. A new user is created if they don't exist.
        Users are assigned the "user" role by default.
      operationId: googleAuth
      tags:
        - google
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GoogleAuthRequest"
      responses:
        "200":
          description: Authentication successful
          headers:
            Set-Cookie:
              description: HTTP-only cookies for access_token and refresh_token
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "400":
          description: Invalid request - access_token or code required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Invalid Google credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Failed to process user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/login:
    post:
      summary: Login (Demo)
      description: |
        Authenticate with email and password.

        **Note**: This is primarily for demo/testing purposes.
        For production, use Google OAuth.

        Returns access and refresh tokens in the response body.
        For web clients, tokens are also set as HTTP-only cookies.
      operationId: login
      tags:
        - auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          headers:
            Set-Cookie:
              description: HTTP-only cookies for access_token and refresh_token
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "400":
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/refresh:
    post:
      summary: Refresh tokens
      description: |
        Get new access and refresh tokens using a valid refresh token.

        The refresh token can be provided via:
        - HTTP-only cookie (web clients)
        - Request body (`refresh_token` field)
        - Header (`X-Refresh-Token`)

        **Note**: Refresh tokens are rotated on each use. The old refresh token becomes invalid.
      operationId: refresh
      tags:
        - auth
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: Tokens refreshed successfully
          headers:
            Set-Cookie:
              description: New HTTP-only cookies for access_token and refresh_token
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/logout:
    post:
      summary: Logout
      description: |
        Logout the current session by revoking the refresh token.

        The refresh token can be provided via cookie, body, or header.
      operationId: logout
      tags:
        - auth
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/logout-all:
    post:
      summary: Logout all sessions
      description: Revoke all refresh tokens for the current user
      operationId: logoutAll
      tags:
        - auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: All sessions revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoutAllResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/sessions:
    get:
      summary: List active sessions
      description: Get a list of all active sessions for the current user
      operationId: listSessions
      tags:
        - auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of active sessions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /protected/secret:
    get:
      summary: Secret endpoint
      description: A protected endpoint that requires authentication
      operationId: getSecret
      tags:
        - protected
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Secret data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecretResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /protected/profile:
    get:
      summary: Get user profile
      description: Get the current user's profile information
      operationId: getProfile
      tags:
        - protected
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProfileResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /protected/admin/dashboard:
    get:
      summary: Admin dashboard
      description: Admin-only endpoint
      operationId: getAdminDashboard
      tags:
        - protected
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Admin dashboard data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminDashboardResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # Admin endpoints for role and permission management
  /admin/permissions:
    get:
      summary: List all permissions
      description: Returns all available permissions in the system. Requires admin role.
      operationId: listPermissions
      tags:
        - admin
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of permissions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Permission"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/roles:
    get:
      summary: List all roles
      description: Returns all roles with their associated permissions. Requires admin role.
      operationId: listRoles
      tags:
        - admin
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Role"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      summary: Create a new role
      description: Creates a new role. Requires admin role.
      operationId: createRole
      tags:
        - admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateRoleRequest"
      responses:
        "201":
          description: Role created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Role"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Role already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/roles/{id}:
    get:
      summary: Get a role
      description: Returns a single role with its permissions. Requires admin role.
      operationId: getRole
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Role ID
      responses:
        "200":
          description: Role details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Role"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Role not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      summary: Update a role
      description: Updates a role's name and description. System roles cannot be renamed. Requires admin role.
      operationId: updateRole
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Role ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateRoleRequest"
      responses:
        "200":
          description: Role updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Role"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role or trying to rename system role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Role not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Role name already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete a role
      description: Deletes a role. System roles cannot be deleted. Requires admin role.
      operationId: deleteRole
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Role ID
      responses:
        "200":
          description: Role deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: role deleted
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role or trying to delete system role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Role not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/roles/{id}/permissions:
    put:
      summary: Set role permissions
      description: |
        Replaces all permissions for a role with the provided list.
        Requires admin role.
      operationId: setRolePermissions
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Role ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SetRolePermissionsRequest"
      responses:
        "200":
          description: Permissions updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Role"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Role not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token

  schemas:
    PingResponse:
      type: object
      properties:
        message:
          type: string
          example: pong
      required:
        - message

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
      required:
        - status

    ReadyResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
          example: ok
        database:
          type: string
          enum: [connected, disconnected]
        redis:
          type: string
          enum: [connected, disconnected]
      required:
        - status
        - database
        - redis

    GoogleConfigResponse:
      type: object
      properties:
        client_id:
          type: string
          description: Google OAuth client ID
          example: "123456789.apps.googleusercontent.com"
        redirect_uri:
          type: string
          description: OAuth redirect URI
          example: "http://localhost:3000/login"
      required:
        - client_id
        - redirect_uri

    GoogleAuthRequest:
      type: object
      properties:
        access_token:
          type: string
          description: Google OAuth access token (for implicit flow)
        code:
          type: string
          description: Google OAuth authorization code (for auth code flow)
      description: Either access_token or code must be provided

    AuthResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token
        refresh_token:
          type: string
          description: Refresh token for obtaining new access tokens
        access_token_expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 900
        token_type:
          type: string
          example: Bearer
        user:
          $ref: "#/components/schemas/User"
      required:
        - access_token
        - refresh_token
        - access_token_expires_in
        - token_type
        - user

    User:
      type: object
      properties:
        id:
          type: integer
          description: User ID
          example: 1
        email:
          type: string
          format: email
          example: user@example.com
        name:
          type: string
          example: John Doe
        picture:
          type: string
          format: uri
          description: Profile picture URL
          example: "https://lh3.googleusercontent.com/..."
        role:
          type: string
          description: User's role
          example: user
        permissions:
          type: array
          items:
            type: string
          description: List of user's permissions
          example: ["ping:read", "news:read"]
      required:
        - id
        - email
        - name
        - picture
        - role

    LoginRequest:
      type: object
      properties:
        username:
          type: string
          example: john
        password:
          type: string
          format: password
          example: password123
      required:
        - username
        - password

    RefreshRequest:
      type: object
      properties:
        refresh_token:
          type: string
          description: The refresh token (if not using cookies)

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token
        refresh_token:
          type: string
          description: Refresh token for obtaining new access tokens
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 900
        refresh_expires_in:
          type: integer
          description: Refresh token expiry in seconds
          example: 604800
      required:
        - access_token
        - refresh_token
        - token_type
        - expires_in
        - refresh_expires_in

    MessageResponse:
      type: object
      properties:
        message:
          type: string
      required:
        - message

    LogoutAllResponse:
      type: object
      properties:
        message:
          type: string
          example: all sessions revoked
        revoked_count:
          type: integer
          description: Number of sessions revoked
          example: 3
      required:
        - message
        - revoked_count

    SessionsResponse:
      type: object
      properties:
        sessions:
          type: array
          items:
            $ref: "#/components/schemas/Session"
      required:
        - sessions

    Session:
      type: object
      properties:
        token_id:
          type: string
          description: Unique session identifier
        user_agent:
          type: string
          description: Browser/client user agent
        ip_address:
          type: string
          description: IP address of the session
        created_at:
          type: string
          format: date-time
          description: When the session was created
        expires_at:
          type: string
          format: date-time
          description: When the session expires
      required:
        - token_id
        - created_at
        - expires_at

    SecretResponse:
      type: object
      properties:
        message:
          type: string
          example: This is a protected secret!
        user:
          type: string
          description: User ID from the JWT
        role:
          type: string
          description: User role from the JWT
      required:
        - message
        - user
        - role

    ProfileResponse:
      type: object
      properties:
        user_id:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
      required:
        - user_id
        - email
        - role

    AdminDashboardResponse:
      type: object
      properties:
        message:
          type: string
          example: Welcome to admin dashboard
        user_id:
          type: string
        role:
          type: string
          example: admin
      required:
        - message
        - user_id
        - role

    Error:
      type: object
      properties:
        error:
          type: string
      required:
        - error

    Permission:
      type: object
      properties:
        id:
          type: integer
          description: Permission ID
          example: 1
        name:
          type: string
          description: Permission name in format resource:action
          example: "news:read"
        description:
          type: string
          description: Human-readable description
          example: "Can read news articles"
        resource:
          type: string
          description: Resource this permission applies to
          example: "news"
        action:
          type: string
          description: Action this permission grants
          example: "read"
      required:
        - id
        - name
        - description
        - resource
        - action

    Role:
      type: object
      properties:
        id:
          type: integer
          description: Role ID
          example: 1
        name:
          type: string
          description: Role name
          example: "editor"
        description:
          type: string
          description: Human-readable description
          example: "Editor with news management access"
        is_system:
          type: boolean
          description: Whether this is a system role (cannot be deleted)
          example: false
        permissions:
          type: array
          items:
            $ref: "#/components/schemas/Permission"
          description: Permissions assigned to this role
      required:
        - id
        - name
        - description
        - is_system
        - permissions

    CreateRoleRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: Role name
          example: "moderator"
        description:
          type: string
          maxLength: 255
          description: Role description
          example: "Moderator with content moderation access"
      required:
        - name

    UpdateRoleRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: Role name
          example: "moderator"
        description:
          type: string
          maxLength: 255
          description: Role description
          example: "Updated moderator description"
      required:
        - name

    SetRolePermissionsRequest:
      type: object
      properties:
        permission_ids:
          type: array
          items:
            type: integer
          description: List of permission IDs to assign to the role
          example: [1, 2, 3]
      required:
        - permission_ids
